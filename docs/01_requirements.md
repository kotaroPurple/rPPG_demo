## rPPG デスクトップアプリ 要求仕様書（uv + DearPyGUI）

最終更新: 2025-08-24

### 1. 目的
- PC内蔵カメラで顔の皮膚領域からrPPG信号を推定し、心拍数(BPM)と波形をリアルタイム表示・保存する。
- 論文「Algorithmic Principles of Remote Photoplethysmography (rPPG), TBME 2016 (Wang, Stuijk, de Haan)」のCHROM/POSを実装・比較できること。

### 2. スコープ
- 入力: 内蔵/USBカメラ映像（カラー）。
- 出力: rPPG波形、BPM、品質指標(SNR/ピーク信頼度)、ログ、CSV/JSON保存。
- UI: 映像プレビュー、ROI可視化、波形・スペクトル、BPM表示、パラメータ設定。

### 3. 対象環境
- OS: macOS (優先), Windows 10+, Linux (参考)
- Python: 3.12 以上（`uv` により仮想環境/依存を管理）
- カメラ: 30 fps 推奨（最低 24 fps）。解像度は 640x480 以上を推奨。

### 4. セットアップ（uv）
- 前提: `uv` は本環境にインストール済み
- 仮想環境作成: `uv venv --python 3.12`
- 依存追加（例・プロジェクトへ固定）:
  - `uv add opencv-python dearpygui mediapipe numpy scipy`
  - 依存の再現: `uv sync`

### 5. 依存ライブラリ（確定）
- OpenCV (`opencv-python`)：カメラ取得、画像処理
- MediaPipe（推奨）または Dlib/`face_recognition`：顔検出・ランドマーク（ROI抽出）
- DearPyGUI：デスクトップUI、波形/スペクトル描画
- NumPy/SciPy：信号処理（フィルタ、FFT）

### 6. 機能要件
- カメラ入力
  - カメラデバイス選択、解像度/FPS設定、プレビュー表示、ミラー表示切替
  - 露出/ホワイトバランスの自動制御は既定（固定化はオプション対応）
- ROI抽出
  - 顔検出とランドマークによる皮膚領域（両頬＋額）マスク作成
  - ROIのドリフト抑制（追跡、最小面積・スキンマスクで外れ値除去）
- rPPG推定
  - CHROM と POS を実装（切替可能、共通の前処理）
  - 窓処理（オーバーラップ）、バンドパス(0.7–4.0 Hz) フィルタ
  - BPM推定（FFTピーク＋範囲制約 42–240 BPM）
  - 品質指標（例: SNR, ピーク信頼度）算出
- 表示/記録（DearPyGUI）
  - 映像プレビュー（ROI枠/マスク重畳）
  - 波形/スペクトルのリアルタイム更新（≤10 Hz）
  - 数値表示：現在BPM、品質指標、FPS
  - 取得データ保存：CSV/JSON（タイムスタンプ、R/G/B平均、rPPG、BPM）
  - スクリーンショット保存（任意）
- 設定・制御
  - アルゴリズム選択（POS/CHROM）
  - 窓長・ステップ、バンドパス周波数、ROIモード、BPM範囲の編集
  - スタート/ストップ、記録ON/OFF、リセット

### 7. 非機能要件
- レイテンシ: 推定BPMの更新遅延 ≤ 2 秒（窓長依存）
- パフォーマンス: 720p 30fps 入力で CPU 占有率 1コア相当以内を目安
- 安定性: 連続30分動作でフリーズ/メモリリークなし
- 可搬性: `uv` 仮想環境で動作、最小限の手動設定で起動

### 8. 品質・受け入れ基準
- 標準状態（屋内拡散照明、軽微動作）で HR MAE ≤ 5 BPM（参照デバイス比）
- 実時間で rPPG 波形が可視、スペクトルに心拍ピークが明瞭
- 顔が画面から外れた際にリカバリ可能（自動再検出）
- 記録ファイルが指定フォーマット/頻度で保存されること

### 9. ユーザ操作フロー
1) アプリ起動 → カメラ選択 → プレビュー表示
2) ROI自動生成（必要なら手動微調整）
3) 計測開始（波形/BPM更新）
4) 記録ON/OFF、パラメータ調整
5) 計測停止 → ファイル保存確認

### 10. エラー/例外ハンドリング
- カメラ未検出/アクセス拒否: 明示的エラーと再試行ボタン
- FPS低下/ドロップ: ステータス警告と自動ダウンサンプリング
- 顔未検出: ガイダンス表示（姿勢/光条件の改善）
- 記録失敗: パス/権限メッセージと再試行

### 11. データ/プライバシー
- 画像・rPPG・BPMはローカル処理。外部送信なし。
- 保存データはユーザ明示操作でのみ作成。ファイル位置をUIで確認可能。

### 12. 既定パラメータ（初期値）
- アルゴリズム: POS（CHROM選択可）
- バンドパス: 0.7–4.0 Hz（IIR/FIRは実装側で選択）
- 窓長/ステップ: 2.0 s / 1.0 s（50%重なり）
- BPM範囲: 42–240 BPM
- ROI: 頬×2＋額の加重平均（スキンマスクで非皮膚除外）

### 13. アーキテクチャ概要
- `Capture`：カメラ取得、フレーム時刻、FPS計測（OpenCV）
- `FaceROI`：顔検出・ランドマーク・スキンマスク・追跡（MediaPipe等）
- `RPPGCore`：前処理（平均RGB、正規化、フィルタ）、CHROM/POS合成、BPM推定（NumPy/SciPy）
- `Quality`：SNR/信頼度算出
- `UI`（DearPyGUI）：プレビュー・波形・スペクトル・制御
- `Recorder`：CSV/JSON/メタ保存

### 14. 妥当性確認（開発時テスト）
- 静止顔・良好照明でBPMが参照機器±5 BPM以内
- 5秒以上の顔ロスト後の自動復帰
- パラメータ変更が即時反映（次窓以降）

### 15. 制約・前提
- 自動画質調整（露出/ホワイトバランス）は機種依存で完全固定不可な場合あり
- 低照度や強い直射/点光源でSNR低下。拡散照明を推奨
- 髭/濃いメイク/大きな頭部運動で性能低下

### 16. 将来拡張
- 呼吸数推定、SpO2関連指標（研究目的）
- マルチROIのロバスト合成（重み最適化）
- 動き補償（光フロー/顕著性重み）
- 自動ホワイトバランス固定API連携（対応機種）

---
本仕様は初版です。実装・評価に応じて適宜更新します。
